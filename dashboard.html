<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace Manager Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .workplace-selector {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .workplace-selector h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .workplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .workplace-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .workplace-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.2);
        }

        .workplace-card.selected {
            border-color: #28a745;
            background: #f8fff9;
        }

        .workplace-card h4 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .workplace-card p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #6c757d;
            font-size: 1rem;
            white-space: nowrap;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: white;
        }

        .content {
            padding: 2rem;
            min-height: 500px;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .user-table th,
        .user-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .user-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .user-table tr:hover {
            background: #f8f9fa;
        }

        .availability-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .day-availability {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .day-availability h4 {
            margin-bottom: 1rem;
            color: #333;
            font-size: 0.9rem;
        }

        .time-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .time-slot input {
            width: 70px;
            padding: 0.25rem;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 5px;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .schedule-content {
            margin-top: 2rem;
        }

        .schedule-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .schedule-option {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .schedule-option:hover {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .schedule-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: none;
        }

        .schedule-form h4 {
            margin-bottom: 1rem;
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .schedule-day-header {
            background: #007bff;
            color: white;
            padding: 0.75rem 1rem;
            margin: 1rem 0 0.5rem 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .schedule-shift {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            border-radius: 0 5px 5px 0;
        }

        .schedule-shift.unfilled {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .schedule-shift.work-study {
            border-left-color: #28a745;
            background-color: rgba(40, 167, 69, 0.1);
        }

        .schedule-time {
            font-weight: bold;
            color: #333;
        }

        .schedule-workers {
            color: #6c757d;
        }

        .unfilled-text {
            color: #dc3545;
            font-weight: bold;
        }

        .publish-banner {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            text-align: center;
            border: 1px solid #c3e6cb;
        }

        .publish-btn {
            background: #28a745;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto 1rem auto;
        }

        .publish-btn:hover {
            background: #1e7e34;
        }

        .schedule-warning {
            background: #fff3cd;
            color: #856404;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border: 1px solid #ffeaa7;
        }

        .work-study-issue {
            color: #dc3545;
            margin-bottom: 0.25rem;
        }

        .schedule-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .schedule-list-item:hover {
            background: #f8f9fa;
        }

        .schedule-list-item.current {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .schedule-date {
            font-weight: bold;
            color: #333;
        }

        .schedule-actions {
            display: flex;
            gap: 0.5rem;
        }

        .history-btn {
            padding: 0.5rem 1rem;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .history-btn:hover {
            background: #0056b3;
        }

        .override-shift-row {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            align-items: flex-start;
        }

        .override-worker-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .override-worker-item {
            padding: 0.25rem 0.75rem;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .override-worker-item:hover {
            background: #007bff;
            color: white;
        }

        .override-worker-item.selected {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .print-options {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            .header h1 {
                font-size: 2rem;
            }

            .tabs {
                flex-direction: column;
            }

            .content {
                padding: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .availability-grid {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .schedule-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🏢 Workplace Manager</h1>
            <p>Comprehensive Employee Scheduling & Management System</p>
        </header>

        <div class="workplace-selector">
            <h3>Select Workplace</h3>
            <div class="workplace-grid" id="workplaceGrid">
                <div class="loading">Loading workplaces...</div>
            </div>
        </div>

        <nav class="tabs">
            <button class="tab active" data-tab="workers">👥 Workers</button>
            <button class="tab" data-tab="hours">🕒 Hours</button>
            <button class="tab" data-tab="schedule">📅 Schedule</button>
            <button class="tab" data-tab="reports">📊 Reports</button>
            <button class="tab" data-tab="settings">⚙️ Settings</button>
        </nav>

        <main class="content">
            <!-- Workers Tab -->
            <div id="workers-tab" class="tab-content active">
                <h2>👥 Workers Management</h2>
                <p>Manage your team members and their availability.</p>
                
                <div class="form-group">
                    <button class="btn btn-success" onclick="showAddWorkerForm()">➕ Add New Worker</button>
                </div>

                <div id="addWorkerForm" class="form-group hidden">
                    <h3>Add New Worker</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="firstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="lastName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Work Study Student</label>
                            <select id="workStudy" class="form-control">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4>Availability</h4>
                    <div class="availability-grid" id="availabilityGrid">
                        <!-- Availability slots will be populated by JavaScript -->
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-success" onclick="addWorker()">Add Worker</button>
                        <button class="btn btn-secondary" onclick="hideAddWorkerForm()">Cancel</button>
                    </div>
                </div>

                <div id="workersContent">
                    <div class="loading">Select a workplace to view workers.</div>
                </div>
            </div>

            <!-- Hours Tab -->
            <div id="hours-tab" class="tab-content hidden">
                <h2>🕒 Hours of Operation</h2>
                <p>Set operating hours for each day of the week.</p>
                
                <div id="hoursContent">
                    <div class="loading">Select a workplace to manage hours.</div>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div id="schedule-tab" class="tab-content hidden">
                <h2>📅 Schedule Management</h2>
                <p>Generate and manage work schedules.</p>
                
                <div class="schedule-options">
                    <div class="schedule-option" id="generateScheduleOption">
                        <h4>🔄 Generate New Schedule</h4>
                        <p>Create an optimized schedule based on availability</p>
                    </div>
                    <div class="schedule-option" id="viewCurrentScheduleOption">
                        <h4>👁️ View Current Schedule</h4>
                        <p>Display the active schedule</p>
                    </div>
                    <div class="schedule-option" id="shiftOverrideOption">
                        <h4>✏️ Modify Shifts</h4>
                        <p>Make manual adjustments to schedules</p>
                    </div>
                    <div class="schedule-option" id="scheduleHistoryOption">
                        <h4>📚 Schedule History</h4>
                        <p>View and manage past schedules</p>
                    </div>
                </div>

                <!-- Generate Schedule Form -->
                <div id="generateScheduleForm" class="schedule-form">
                    <h4>🔄 Generate Schedule Settings</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maxHoursPerWorker">Max Hours per Worker</label>
                            <input type="number" id="maxHoursPerWorker" class="form-control" value="20" min="1" max="40">
                        </div>
                        <div class="form-group">
                            <label for="maxWorkersPerShift">Max Workers per Shift</label>
                            <input type="number" id="maxWorkersPerShift" class="form-control" value="2" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label for="minHoursPerWorker">Min Hours per Worker</label>
                            <input type="number" id="minHoursPerWorker" class="form-control" value="3" min="1" max="20">
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-success" id="generateScheduleBtn">🚀 Generate Schedule</button>
                        <button class="btn btn-secondary" id="cancelGenerateBtn">Cancel</button>
                    </div>
                </div>

                <!-- Shift Override Section -->
                <div id="shiftOverrideSection" class="schedule-form">
                    <h4>✏️ Modify Shift Assignments</h4>
                    <div id="shiftOverrideContent">
                        <!-- Shift override content will be populated by JavaScript -->
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-success" id="saveOverridesBtn">💾 Save Changes</button>
                        <button class="btn btn-secondary" id="cancelOverrideBtn">Cancel</button>
                    </div>
                </div>

                <!-- Schedule History Section -->
                <div id="scheduleHistorySection" class="schedule-form">
                    <h4>📚 Schedule History</h4>
                    <div id="scheduleHistoryList">
                        <!-- Schedule history will be populated by JavaScript -->
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-secondary" id="backToScheduleBtn">← Back to Schedule</button>
                    </div>
                </div>

                <div id="scheduleContent">
                    <div class="loading">Select a workplace and choose an option above to get started.</div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content hidden">
                <h2>📊 Reports & Analytics</h2>
                <p>View detailed reports and analytics.</p>
                
                <div id="reportsContent">
                    <div class="loading">Select a workplace to view reports.</div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content hidden">
                <h2>⚙️ Settings</h2>
                <p>Manage application settings and preferences.</p>
                
                <div id="settingsContent">
                    <div class="form-group">
                        <label>Theme</label>
                        <select class="form-control" id="themeSelector">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Notifications</label>
                        <div>
                            <label>
                                <input type="checkbox" id="emailNotifications" checked>
                                Email Notifications
                            </label>
                        </div>
                        <div>
                            <label>
                                <input type="checkbox" id="pushNotifications" checked>
                                Push Notifications
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-success" onclick="saveSettings()">💾 Save Settings</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

<!-- Firebase and Core Scripts -->
    <script type="module">
        // Firebase Configuration and Core Utilities
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
        import { getFirestore, connectFirestoreEmulator } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHEr8WKHvJOGNYD8sjP2fCcXNNcKFnhI4",
            authDomain: "workplacemanager-7c0a7.firebaseapp.com",
            projectId: "workplacemanager-7c0a7",
            storageBucket: "workplacemanager-7c0a7.firebasestorage.app",
            messagingSenderId: "580551480288",
            appId: "1:580551480288:web:1a0b2e3c4d5f6g7h8i9j0k"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Connect to emulator in development
        if (location.hostname === 'localhost') {
            try {
                connectFirestoreEmulator(db, 'localhost', 8080);
            } catch (error) {
                console.log('Emulator connection failed or already connected');
            }
        }

        // Export to global scope
        window.firebaseApp = app;
        window.workplaceDb = db;

        // Days of the week constant
        window.DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        // Global variables
        window.selectedWorkplace = null;
        window.workers = [];
        window.workplaces = [];
        window.hoursOfOperation = {};

        // Utility Functions
        window.timeToHour = function(timeStr) {
            if (typeof timeStr === 'number') return timeStr;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours + (minutes / 60);
        };

        window.hourToTimeStr = function(hour) {
            if (typeof hour === 'string') return hour;
            const hours = Math.floor(hour);
            const minutes = Math.round((hour - hours) * 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        };

        window.formatTimeAMPM = function(timeStr) {
            if (typeof timeStr === 'number') {
                timeStr = window.hourToTimeStr(timeStr);
            }
            const [hours, minutes] = timeStr.split(':').map(Number);
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
        };

        window.isWorkerAvailableDuringHours = function(worker, day, startHour, endHour) {
            const availability = worker.availability || {};
            const dayAvailability = availability[day] || [];
            
            for (const slot of dayAvailability) {
                if (slot.start_hour <= startHour && slot.end_hour >= endHour) {
                    return true;
                }
            }
            return false;
        };

        window.calculateWorkerFairnessRatio = function(worker, assignedHours) {
            const currentHours = assignedHours[worker.email] || 0;
            const availableHours = worker.total_availability_hours || 1;
            return currentHours / availableHours;
        };

        // Authentication and Permission Check
        window.checkPermissions = function() {
            // For demo purposes, always return true
            // In production, implement proper authentication
            return true;
        };

        // Initialize the application
        window.initApp = async function() {
            console.log('🚀 Initializing Workplace Manager...');
            
            if (!window.checkPermissions()) {
                document.body.innerHTML = '<div style="text-align: center; padding: 2rem;"><h2>Access Denied</h2><p>You do not have permission to access this application.</p></div>';
                return;
            }

            // Load workplaces
            await loadWorkplaces();
            
            // Setup tab navigation
            setupTabNavigation();
            
            // Setup event listeners
            setupEventListeners();
            
            console.log('✅ Application initialized successfully');
        };

        // Tab Navigation
        window.setupTabNavigation = function() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.add('hidden'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                    
                    // Load content for the selected tab
                    loadTabContent(targetTab);
                });
            });
        };

        // Load content for tabs
        window.loadTabContent = async function(tabName) {
            if (!window.selectedWorkplace) return;

            switch (tabName) {
                case 'workers':
                    await loadWorkers();
                    break;
                case 'hours':
                    await loadHours();
                    break;
                case 'schedule':
                    // Schedule content is handled by schedule.js
                    break;
                case 'reports':
                    await loadReports();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        };

        // Event Listeners Setup
        window.setupEventListeners = function() {
            // No additional global event listeners needed at this time
            // Individual modules handle their own events
        };

        console.log('📄 Dashboard HTML and core utilities loaded');
    </script>

<script type="module">
        // Workplace and Workers Management
        import { collection, getDocs, doc, updateDoc, getDoc, addDoc, query, where, orderBy, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

        // Load workplaces
        window.loadWorkplaces = async function() {
            try {
                console.log('📂 Loading workplaces...');
                const workplaceGrid = document.getElementById('workplaceGrid');
                workplaceGrid.innerHTML = '<div class="loading">Loading workplaces...</div>';

                const querySnapshot = await getDocs(collection(window.workplaceDb, 'workplaces'));
                
                if (querySnapshot.empty) {
                    // Create default workplaces if none exist
                    await createDefaultWorkplaces();
                    return loadWorkplaces(); // Reload after creating defaults
                }

                window.workplaces = [];
                let workplacesHtml = '';

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const workplace = {
                        id: doc.id,
                        name: data.name || doc.id.replace('_', ' ').toUpperCase(),
                        description: data.description || 'Workplace location',
                        worker_count: data.worker_count || 0,
                        ...data
                    };
                    
                    window.workplaces.push(workplace);
                    
                    workplacesHtml += `
                        <div class="workplace-card" onclick="selectWorkplace('${workplace.id}')">
                            <h4>${workplace.name}</h4>
                            <p>${workplace.description}</p>
                            <p><strong>${workplace.worker_count}</strong> workers</p>
                        </div>
                    `;
                });

                workplaceGrid.innerHTML = workplacesHtml;
                console.log(`✅ Loaded ${window.workplaces.length} workplaces`);
            } catch (error) {
                console.error('❌ Error loading workplaces:', error);
                document.getElementById('workplaceGrid').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading workplaces: ${error.message}
                    </div>
                `;
            }
        };

        // Create default workplaces
        window.createDefaultWorkplaces = async function() {
            const defaultWorkplaces = [
                {
                    id: 'library_main',
                    name: 'Main Library',
                    description: 'Primary campus library location',
                    worker_count: 0
                },
                {
                    id: 'library_science',
                    name: 'Science Library',
                    description: 'Science department library',
                    worker_count: 0
                },
                {
                    id: 'student_center',
                    name: 'Student Center',
                    description: 'Campus student center',
                    worker_count: 0
                }
            ];

            for (const workplace of defaultWorkplaces) {
                await setDoc(doc(window.workplaceDb, 'workplaces', workplace.id), workplace);
            }
        };

        // Select workplace
        window.selectWorkplace = async function(workplaceId) {
            try {
                console.log(`🏢 Selecting workplace: ${workplaceId}`);
                
                // Update UI
                document.querySelectorAll('.workplace-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.target.classList.add('selected');
                
                window.selectedWorkplace = workplaceId;
                
                // Initialize workplace document if it doesn't exist
                await window.initializeWorkplace(workplaceId);
                
                // Load content for current tab
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('data-tab');
                    await loadTabContent(tabName);
                }
                
                console.log(`✅ Selected workplace: ${workplaceId}`);
            } catch (error) {
                console.error('❌ Error selecting workplace:', error);
            }
        };

        // Initialize workplace document
        window.initializeWorkplace = async function(workplaceId) {
            try {
                const workplaceRef = doc(window.workplaceDb, 'workplaces', workplaceId);
                const workplaceDoc = await getDoc(workplaceRef);
                
                if (!workplaceDoc.exists()) {
                    const workplaceData = {
                        name: workplaceId.replace('_', ' ').toUpperCase(),
                        description: 'Workplace location',
                        worker_count: 0,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    await setDoc(workplaceRef, workplaceData);
                    console.log(`📄 Initialized workplace document: ${workplaceId}`);
                }
            } catch (error) {
                console.error('❌ Error initializing workplace:', error);
            }
        };

        // Load workers
        window.loadWorkers = async function() {
            if (!window.selectedWorkplace) {
                document.getElementById('workersContent').innerHTML = '<div class="loading">Select a workplace to view workers.</div>';
                return;
            }

            try {
                console.log(`👥 Loading workers for ${window.selectedWorkplace}...`);
                document.getElementById('workersContent').innerHTML = '<div class="loading">Loading workers...</div>';

                const querySnapshot = await getDocs(
                    query(
                        collection(window.workplaceDb, 'workers'),
                        where('workplace', '==', window.selectedWorkplace),
                        orderBy('first_name')
                    )
                );

                window.workers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    window.workers.push({
                        id: doc.id,
                        ...data
                    });
                });

                displayWorkers();
                console.log(`✅ Loaded ${window.workers.length} workers`);
            } catch (error) {
                console.error('❌ Error loading workers:', error);
                document.getElementById('workersContent').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading workers: ${error.message}
                    </div>
                `;
            }
        };

        // Display workers
        window.displayWorkers = function() {
            if (window.workers.length === 0) {
                document.getElementById('workersContent').innerHTML = `
                    <div class="alert alert-warning">
                        No workers found for this workplace. Add some workers to get started.
                    </div>
                `;
                return;
            }

            let html = `
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Work Study</th>
                            <th>Availability Hours</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            window.workers.forEach(worker => {
                const totalHours = calculateTotalAvailabilityHours(worker.availability || {});
                html += `
                    <tr>
                        <td>${worker.first_name} ${worker.last_name}</td>
                        <td>${worker.email}</td>
                        <td>${worker.work_study ? 'Yes' : 'No'}</td>
                        <td>${totalHours.toFixed(1)} hours</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editWorker('${worker.id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteWorker('${worker.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            document.getElementById('workersContent').innerHTML = html;
        };

        // Calculate total availability hours
        window.calculateTotalAvailabilityHours = function(availability) {
            let total = 0;
            for (const day in availability) {
                const daySlots = availability[day] || [];
                daySlots.forEach(slot => {
                    total += slot.end_hour - slot.start_hour;
                });
            }
            return total;
        };

        // Show add worker form
        window.showAddWorkerForm = function() {
            document.getElementById('addWorkerForm').classList.remove('hidden');
            setupAvailabilityGrid();
        };

        // Hide add worker form
        window.hideAddWorkerForm = function() {
            document.getElementById('addWorkerForm').classList.add('hidden');
            clearWorkerForm();
        };

        // Setup availability grid
        window.setupAvailabilityGrid = function() {
            const grid = document.getElementById('availabilityGrid');
            let html = '';

            window.DAYS.forEach(day => {
                html += `
                    <div class="day-availability">
                        <h4>${day}</h4>
                        <div id="availability-${day}">
                            <div class="time-slot">
                                <input type="time" id="${day}-start-0" value="09:00">
                                <span>to</span>
                                <input type="time" id="${day}-end-0" value="17:00">
                                <button type="button" onclick="addTimeSlot('${day}')" class="btn" style="padding: 0.25rem;">+</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
        };

        // Add time slot
        window.addTimeSlot = function(day) {
            const container = document.getElementById(`availability-${day}`);
            const slotCount = container.children.length;
            
            const newSlot = document.createElement('div');
            newSlot.className = 'time-slot';
            newSlot.innerHTML = `
                <input type="time" id="${day}-start-${slotCount}" value="09:00">
                <span>to</span>
                <input type="time" id="${day}-end-${slotCount}" value="17:00">
                <button type="button" onclick="removeTimeSlot(this)" class="btn btn-danger" style="padding: 0.25rem;">-</button>
            `;
            
            container.appendChild(newSlot);
        };

        // Remove time slot
        window.removeTimeSlot = function(button) {
            button.parentElement.remove();
        };

        // Add worker
        window.addWorker = async function() {
            try {
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const email = document.getElementById('email').value.trim();
                const workStudy = document.getElementById('workStudy').value === 'Yes';

                if (!firstName || !lastName || !email) {
                    alert('Please fill in all required fields.');
                    return;
                }

                // Collect availability
                const availability = {};
                window.DAYS.forEach(day => {
                    const dayContainer = document.getElementById(`availability-${day}`);
                    const timeSlots = dayContainer.querySelectorAll('.time-slot');
                    availability[day] = [];

                    timeSlots.forEach(slot => {
                        const startInput = slot.querySelector('input[type="time"]:first-child');
                        const endInput = slot.querySelector('input[type="time"]:last-child');
                        
                        if (startInput.value && endInput.value) {
                            const startHour = window.timeToHour(startInput.value);
                            const endHour = window.timeToHour(endInput.value);
                            
                            if (endHour > startHour) {
                                availability[day].push({
                                    start_hour: startHour,
                                    end_hour: endHour
                                });
                            }
                        }
                    });
                });

                const totalAvailabilityHours = calculateTotalAvailabilityHours(availability);

                const workerData = {
                    first_name: firstName,
                    last_name: lastName,
                    email: email,
                    work_study: workStudy,
                    availability: availability,
                    total_availability_hours: totalAvailabilityHours,
                    workplace: window.selectedWorkplace,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                await addDoc(collection(window.workplaceDb, 'workers'), workerData);
                
                // Update workplace worker count
                await updateWorkplaceWorkerCount();
                
                alert('✅ Worker added successfully!');
                hideAddWorkerForm();
                await loadWorkers();
                
            } catch (error) {
                console.error('❌ Error adding worker:', error);
                alert('❌ Error adding worker: ' + error.message);
            }
        };

        // Update workplace worker count
        window.updateWorkplaceWorkerCount = async function() {
            try {
                const workplaceRef = doc(window.workplaceDb, 'workplaces', window.selectedWorkplace);
                await updateDoc(workplaceRef, {
                    worker_count: window.workers.length + 1,
                    updated_at: new Date().toISOString()
                });
            } catch (error) {
                console.error('❌ Error updating workplace worker count:', error);
            }
        };

        // Edit worker
        window.editWorker = function(workerId) {
            alert('Edit functionality will be implemented in the next update.');
        };

        // Delete worker
        window.deleteWorker = async function(workerId) {
            if (confirm('Are you sure you want to delete this worker?')) {
                try {
                    await deleteDoc(doc(window.workplaceDb, 'workers', workerId));
                    alert('✅ Worker deleted successfully!');
                    await loadWorkers();
                    await updateWorkplaceWorkerCount();
                } catch (error) {
                    console.error('❌ Error deleting worker:', error);
                    alert('❌ Error deleting worker: ' + error.message);
                }
            }
        };

        // Clear worker form
        window.clearWorkerForm = function() {
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('email').value = '';
            document.getElementById('workStudy').value = 'No';
        };

        // Load workers for scheduling (with calculated availability)
        window.loadWorkersForScheduling = async function(workplace) {
            try {
                const querySnapshot = await getDocs(
                    query(
                        collection(window.workplaceDb, 'workers'),
                        where('workplace', '==', workplace)
                    )
                );

                const workers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    workers.push({
                        id: doc.id,
                        email: data.email,
                        first_name: data.first_name,
                        last_name: data.last_name,
                        work_study: data.work_study,
                        availability: data.availability || {},
                        total_availability_hours: calculateTotalAvailabilityHours(data.availability || {}),
                        ...data
                    });
                });

                return workers;
            } catch (error) {
                console.error('❌ Error loading workers for scheduling:', error);
                throw error;
            }
        };

        console.log('👥 Workers management module loaded');
    </script>

<script type="module">
        // Hours of Operation and Schedule Management
        import { collection, getDocs, doc, updateDoc, getDoc, addDoc, query, orderBy, limit, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

        // Load hours of operation
        window.loadHours = async function() {
            if (!window.selectedWorkplace) {
                document.getElementById('hoursContent').innerHTML = '<div class="loading">Select a workplace to manage hours.</div>';
                return;
            }

            try {
                console.log(`🕒 Loading hours for ${window.selectedWorkplace}...`);
                document.getElementById('hoursContent').innerHTML = '<div class="loading">Loading hours...</div>';

                const hoursRef = doc(window.workplaceDb, 'hours', window.selectedWorkplace);
                const hoursDoc = await getDoc(hoursRef);

                let hours = {};
                if (hoursDoc.exists()) {
                    hours = hoursDoc.data();
                    delete hours.workplace; // Remove workplace field from display
                }

                window.hoursOfOperation = hours;
                displayHoursForm(hours);
                
            } catch (error) {
                console.error('❌ Error loading hours:', error);
                document.getElementById('hoursContent').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading hours: ${error.message}
                    </div>
                `;
            }
        };

        // Display hours form
        window.displayHoursForm = function(hours = {}) {
            let html = `
                <form id="hoursForm">
                    <div class="availability-grid">
            `;

            window.DAYS.forEach(day => {
                const dayHours = hours[day] || [];
                html += `
                    <div class="day-availability">
                        <h4>${day}</h4>
                        <div id="hours-${day}">
                `;

                if (dayHours.length === 0) {
                    html += `
                        <div class="time-slot">
                            <input type="time" id="${day}-start-0" value="09:00">
                            <span>to</span>
                            <input type="time" id="${day}-end-0" value="17:00">
                            <button type="button" onclick="addHoursSlot('${day}')" class="btn" style="padding: 0.25rem;">+</button>
                        </div>
                    `;
                } else {
                    dayHours.forEach((slot, index) => {
                        const startTime = window.hourToTimeStr(slot.start_hour);
                        const endTime = window.hourToTimeStr(slot.end_hour);
                        html += `
                            <div class="time-slot">
                                <input type="time" id="${day}-start-${index}" value="${startTime}">
                                <span>to</span>
                                <input type="time" id="${day}-end-${index}" value="${endTime}">
                                ${index === 0 ? 
                                    `<button type="button" onclick="addHoursSlot('${day}')" class="btn" style="padding: 0.25rem;">+</button>` :
                                    `<button type="button" onclick="removeHoursSlot(this)" class="btn btn-danger" style="padding: 0.25rem;">-</button>`
                                }
                            </div>
                        `;
                    });
                }

                html += `
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                    <div style="margin-top: 2rem;">
                        <button type="button" class="btn btn-success" onclick="saveHours()">💾 Save Hours</button>
                        <button type="button" class="btn btn-secondary" onclick="resetHours()">🔄 Reset</button>
                    </div>
                </form>
            `;

            document.getElementById('hoursContent').innerHTML = html;
        };

        // Add hours slot
        window.addHoursSlot = function(day) {
            const container = document.getElementById(`hours-${day}`);
            const slotCount = container.children.length;
            
            const newSlot = document.createElement('div');
            newSlot.className = 'time-slot';
            newSlot.innerHTML = `
                <input type="time" id="${day}-start-${slotCount}" value="09:00">
                <span>to</span>
                <input type="time" id="${day}-end-${slotCount}" value="17:00">
                <button type="button" onclick="removeHoursSlot(this)" class="btn btn-danger" style="padding: 0.25rem;">-</button>
            `;
            
            container.appendChild(newSlot);
        };

        // Remove hours slot
        window.removeHoursSlot = function(button) {
            button.parentElement.remove();
        };

        // Save hours
        window.saveHours = async function() {
            try {
                const hours = {};
                
                window.DAYS.forEach(day => {
                    const dayContainer = document.getElementById(`hours-${day}`);
                    const timeSlots = dayContainer.querySelectorAll('.time-slot');
                    hours[day] = [];

                    timeSlots.forEach(slot => {
                        const startInput = slot.querySelector('input[type="time"]:first-child');
                        const endInput = slot.querySelector('input[type="time"]:last-child');
                        
                        if (startInput.value && endInput.value) {
                            const startHour = window.timeToHour(startInput.value);
                            const endHour = window.timeToHour(endInput.value);
                            
                            if (endHour > startHour) {
                                hours[day].push({
                                    start_hour: startHour,
                                    end_hour: endHour
                                });
                            }
                        }
                    });
                });

                // Add workplace identifier
                hours.workplace = window.selectedWorkplace;
                hours.updated_at = new Date().toISOString();

                const hoursRef = doc(window.workplaceDb, 'hours', window.selectedWorkplace);
                await setDoc(hoursRef, hours);

                window.hoursOfOperation = hours;
                alert('✅ Hours saved successfully!');
                
            } catch (error) {
                console.error('❌ Error saving hours:', error);
                alert('❌ Error saving hours: ' + error.message);
            }
        };

        // Reset hours
        window.resetHours = function() {
            if (confirm('Are you sure you want to reset the hours to default?')) {
                const defaultHours = {};
                window.DAYS.forEach(day => {
                    defaultHours[day] = [{
                        start_hour: 9,
                        end_hour: 17
                    }];
                });
                displayHoursForm(defaultHours);
            }
        };

        // Load hours for scheduling
        window.loadHoursForScheduling = async function(workplace) {
            try {
                const hoursRef = doc(window.workplaceDb, 'hours', workplace);
                const hoursDoc = await getDoc(hoursRef);

                if (hoursDoc.exists()) {
                    const data = hoursDoc.data();
                    delete data.workplace; // Remove workplace field
                    delete data.updated_at; // Remove timestamp
                    return data;
                } else {
                    // Return default hours if none exist
                    const defaultHours = {};
                    window.DAYS.forEach(day => {
                        defaultHours[day] = [{
                            start_hour: 9,
                            end_hour: 17
                        }];
                    });
                    return defaultHours;
                }
            } catch (error) {
                console.error('❌ Error loading hours for scheduling:', error);
                throw error;
            }
        };

        // Load reports
        window.loadReports = async function() {
            if (!window.selectedWorkplace) {
                document.getElementById('reportsContent').innerHTML = '<div class="loading">Select a workplace to view reports.</div>';
                return;
            }

            try {
                console.log(`📊 Loading reports for ${window.selectedWorkplace}...`);
                document.getElementById('reportsContent').innerHTML = '<div class="loading">Loading reports...</div>';

                // Load workers and schedule data for reports
                const [workersData, hoursData] = await Promise.all([
                    window.loadWorkersForScheduling(window.selectedWorkplace),
                    window.loadHoursForScheduling(window.selectedWorkplace)
                ]);

                // Load current schedule if exists
                let currentSchedule = null;
                try {
                    await window.loadCurrentSchedule();
                    currentSchedule = window.currentSchedule;
                } catch (error) {
                    console.log('No current schedule found for reports');
                }

                displayReports(workersData, hoursData, currentSchedule);
                
            } catch (error) {
                console.error('❌ Error loading reports:', error);
                document.getElementById('reportsContent').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading reports: ${error.message}
                    </div>
                `;
            }
        };

        // Display reports
        window.displayReports = function(workers, hours, schedule) {
            let html = '';

            // Basic statistics
            const totalWorkers = workers.length;
            const workStudyWorkers = workers.filter(w => w.work_study).length;
            const totalAvailableHours = workers.reduce((sum, worker) => sum + (worker.total_availability_hours || 0), 0);

            html += `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalWorkers}</div>
                        <div class="stat-label">Total Workers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${workStudyWorkers}</div>
                        <div class="stat-label">Work Study Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalAvailableHours.toFixed(1)}</div>
                        <div class="stat-label">Total Available Hours</div>
                    </div>
                </div>
            `;

            // Worker availability summary
            html += `
                <h3>👥 Worker Availability Summary</h3>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Worker</th>
                            <th>Work Study</th>
                            <th>Available Hours</th>
                            <th>Days Available</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            workers.forEach(worker => {
                const availability = worker.availability || {};
                const daysAvailable = Object.keys(availability).filter(day => availability[day].length > 0).length;
                
                html += `
                    <tr>
                        <td>${worker.first_name} ${worker.last_name}</td>
                        <td>${worker.work_study ? 'Yes' : 'No'}</td>
                        <td>${(worker.total_availability_hours || 0).toFixed(1)}</td>
                        <td>${daysAvailable}/7</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            // Schedule analysis if available
            if (schedule) {
                const assignedHours = window.calculateAssignedHours(schedule);
                const totalScheduledHours = Object.values(assignedHours).reduce((sum, hours) => sum + hours, 0);
                const totalShifts = Object.values(schedule).flat().length;

                html += `
                    <h3>📅 Current Schedule Analysis</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${totalShifts}</div>
                            <div class="stat-label">Total Shifts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalScheduledHours.toFixed(1)}</div>
                            <div class="stat-label">Scheduled Hours</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Object.keys(assignedHours).length}</div>
                            <div class="stat-label">Workers Scheduled</div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <h3>📅 Schedule Analysis</h3>
                    <div class="alert alert-warning">
                        No current schedule found. Generate a schedule to see detailed analysis.
                    </div>
                `;
            }

            // Operating hours summary
            html += `
                <h3>🕒 Operating Hours Summary</h3>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Hours</th>
                            <th>Total Hours</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let totalOperatingHours = 0;
            window.DAYS.forEach(day => {
                const dayHours = hours[day] || [];
                let dayTotal = 0;
                const hoursText = dayHours.map(slot => {
                    const duration = slot.end_hour - slot.start_hour;
                    dayTotal += duration;
                    return `${window.formatTimeAMPM(window.hourToTimeStr(slot.start_hour))} - ${window.formatTimeAMPM(window.hourToTimeStr(slot.end_hour))}`;
                }).join(', ') || 'Closed';
                
                totalOperatingHours += dayTotal;
                
                html += `
                    <tr>
                        <td>${day}</td>
                        <td>${hoursText}</td>
                        <td>${dayTotal.toFixed(1)} hours</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: bold;">
                            <td>Total Weekly</td>
                            <td></td>
                            <td>${totalOperatingHours.toFixed(1)} hours</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            document.getElementById('reportsContent').innerHTML = html;
        };

        // Load settings
        window.loadSettings = function() {
            // Load settings from localStorage
            const theme = localStorage.getItem('theme') || 'light';
            const emailNotifications = localStorage.getItem('emailNotifications') !== 'false';
            const pushNotifications = localStorage.getItem('pushNotifications') !== 'false';

            document.getElementById('themeSelector').value = theme;
            document.getElementById('emailNotifications').checked = emailNotifications;
            document.getElementById('pushNotifications').checked = pushNotifications;

            // Apply theme
            applyTheme(theme);
        };

        // Save settings
        window.saveSettings = function() {
            const theme = document.getElementById('themeSelector').value;
            const emailNotifications = document.getElementById('emailNotifications').checked;
            const pushNotifications = document.getElementById('pushNotifications').checked;

            localStorage.setItem('theme', theme);
            localStorage.setItem('emailNotifications', emailNotifications);
            localStorage.setItem('pushNotifications', pushNotifications);

            applyTheme(theme);
            alert('✅ Settings saved successfully!');
        };

        // Apply theme
        window.applyTheme = function(theme) {
            if (theme === 'dark') {
                document.body.style.background = 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)';
                document.querySelector('.container').style.background = '#34495e';
                document.querySelector('.container').style.color = '#ecf0f1';
            } else {
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.querySelector('.container').style.background = 'white';
                document.querySelector('.container').style.color = 'inherit';
            }
        };

        console.log('🕒 Hours and reports management module loaded');
    </script>

<script type="module">
        // Complete Schedule Management with Full Export Functionality
        import { collection, getDocs, doc, updateDoc, getDoc, addDoc, query, orderBy, limit, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

        // Advanced scheduling configuration
        const SHIFT_LENGTHS = [2, 3, 4, 5]; // Possible shift lengths in hours
        const WORK_STUDY_TARGET_HOURS = 5; // Work study students need exactly 5 hours
        const PREFERRED_WS_SPLITS = [
            { split1: 3, split2: 2 }, // Preferred 3+2 hour split
            { split1: 2, split2: 3 }  // Alternative 2+3 hour split
        ];

        // Global schedule variables
        window.currentSchedule = null;
        window.draftSchedule = null;
        window.currentShiftOverrides = {};
        window.selectedScheduleId = null;

        // Initialize schedule module
        document.addEventListener('DOMContentLoaded', function() {
            setupScheduleEventListeners();
        });

        function setupScheduleEventListeners() {
            // Schedule option buttons
            const generateScheduleOption = document.getElementById('generateScheduleOption');
            if (generateScheduleOption) {
                generateScheduleOption.addEventListener('click', showGenerateScheduleForm);
            }
            
            const viewCurrentScheduleOption = document.getElementById('viewCurrentScheduleOption');
            if (viewCurrentScheduleOption) {
                viewCurrentScheduleOption.addEventListener('click', viewCurrentSchedule);
            }
            
            const shiftOverrideOption = document.getElementById('shiftOverrideOption');
            if (shiftOverrideOption) {
                shiftOverrideOption.addEventListener('click', openShiftOverride);
            }
            
            const scheduleHistoryOption = document.getElementById('scheduleHistoryOption');
            if (scheduleHistoryOption) {
                scheduleHistoryOption.addEventListener('click', viewScheduleHistory);
            }
            
            // Generate schedule buttons
            const generateScheduleBtn = document.getElementById('generateScheduleBtn');
            if (generateScheduleBtn) {
                generateScheduleBtn.addEventListener('click', generateSchedule);
            }
            
            const cancelGenerateBtn = document.getElementById('cancelGenerateBtn');
            if (cancelGenerateBtn) {
                cancelGenerateBtn.addEventListener('click', hideGenerateScheduleForm);
            }
            
            // Shift override buttons
            const saveOverridesBtn = document.getElementById('saveOverridesBtn');
            if (saveOverridesBtn) {
                saveOverridesBtn.addEventListener('click', saveShiftOverrides);
            }
            
            const cancelOverrideBtn = document.getElementById('cancelOverrideBtn');
            if (cancelOverrideBtn) {
                cancelOverrideBtn.addEventListener('click', hideShiftOverride);
            }
            
            // Schedule history buttons
            const backToScheduleBtn = document.getElementById('backToScheduleBtn');
            if (backToScheduleBtn) {
                backToScheduleBtn.addEventListener('click', hideScheduleHistory);
            }
        }

        // Show generate schedule form
        window.showGenerateScheduleForm = function() {
            document.getElementById('generateScheduleForm').style.display = 'block';
            document.getElementById('shiftOverrideSection').style.display = 'none';
            document.getElementById('scheduleHistorySection').style.display = 'none';
            document.getElementById('scheduleContent').innerHTML = '<p>Configure your schedule settings above.</p>';
        };

        // Hide generate schedule form
        window.hideGenerateScheduleForm = function() {
            document.getElementById('generateScheduleForm').style.display = 'none';
            document.getElementById('scheduleContent').innerHTML = '<p>Select an option above to get started.</p>';
        };

        // Generate advanced schedule
        window.generateSchedule = async function() {
            if (!window.selectedWorkplace) {
                alert('Please select a workplace first.');
                return;
            }
            
            document.getElementById('scheduleContent').innerHTML = `
                <div class="loading">🔄 Generating advanced schedule for ${window.selectedWorkplace}...</div>
            `;
            
            try {
                // Get schedule settings from form
                const maxHoursPerWorker = parseInt(document.getElementById('maxHoursPerWorker').value) || 20;
                const maxWorkersPerShift = parseInt(document.getElementById('maxWorkersPerShift').value) || 2;
                const minHoursPerWorker = parseInt(document.getElementById('minHoursPerWorker').value) || 3;
                
                // Load workers and hours data
                const [workersData, hoursData] = await Promise.all([
                    window.loadWorkersForScheduling(window.selectedWorkplace),
                    window.loadHoursForScheduling(window.selectedWorkplace)
                ]);
                
                console.log('📊 Generating advanced schedule with:', { 
                    workers: workersData.length, 
                    hoursData,
                    maxHoursPerWorker,
                    maxWorkersPerShift,
                    minHoursPerWorker
                });
                
                // Validate prerequisites
                const validationResult = validateSchedulingPrerequisites(workersData, hoursData);
                if (!validationResult.valid) {
                    document.getElementById('scheduleContent').innerHTML = validationResult.errorHtml;
                    return;
                }
                
                // Generate the schedule using the advanced algorithm
                const scheduleResult = await createAdvancedScheduleFromAvailability(
                    hoursData, 
                    workersData, 
                    window.selectedWorkplace,
                    maxHoursPerWorker,
                    maxWorkersPerShift,
                    minHoursPerWorker
                );
                
                // Save the generated schedule to Firebase as a draft
                const scheduleId = await saveScheduleToFirebase(scheduleResult.schedule, false);
                window.draftSchedule = scheduleResult.schedule;
                
                // Hide the generation form
                document.getElementById('generateScheduleForm').style.display = 'none';
                
                // Display the schedule with comprehensive analytics
                displayAdvancedScheduleWithAnalytics(scheduleResult, false, scheduleId);
                
            } catch (error) {
                console.error('❌ Error generating schedule:', error);
                document.getElementById('scheduleContent').innerHTML = `
                    <div class="schedule-warning">
                        <h5>❌ Error Generating Schedule</h5>
                        <p>Error: ${error.message}</p>
                        <p><small>Please check your workers' availability and hours of operation settings.</small></p>
                    </div>
                `;
            }
        };

        // Validate prerequisites for schedule generation
        function validateSchedulingPrerequisites(workersData, hoursData) {
            if (workersData.length === 0) {
                return {
                    valid: false,
                    errorHtml: `
                        <div class="schedule-warning">
                            <h5>⚠️ No Workers Available</h5>
                            <p>Add workers to the workplace before generating a schedule.</p>
                            <p><small>Navigate to the Workers tab to add workers with their availability.</small></p>
                        </div>
                    `
                };
            }
            
            if (Object.keys(hoursData).length === 0) {
                return {
                    valid: false,
                    errorHtml: `
                        <div class="schedule-warning">
                            <h5>⚠️ No Hours of Operation</h5>
                            <p>Set hours of operation for the workplace before generating a schedule.</p>
                            <p><small>Navigate to the Hours tab to configure operating hours.</small></p>
                        </div>
                    `
                };
            }
            
            return { valid: true };
        }

        // FIXED ADVANCED SCHEDULE CREATION ALGORITHM
        async function createAdvancedScheduleFromAvailability(hoursOfOperation, workersData, workplace, maxHoursPerWorker, maxWorkersPerShift, minHoursPerWorker) {
            console.log('🚀 Starting fixed advanced schedule generation...');
            
            // Initialize tracking variables
            const schedule = {};
            const assignedHours = {};
            const unfilledShifts = [];
            const alternativeSolutions = {};
            const wsIssues = [];
            
            // Initialize worker hours tracking - CRITICAL FIX
            workersData.forEach(w => {
                assignedHours[w.email] = 0;
            });
            
            console.log('📋 Initial assigned hours:', assignedHours);
            
            // PHASE 1: Assign work study students exactly 5 hours
            console.log('📋 Phase 1: Assigning work study students...');
            const workStudyWorkers = workersData.filter(w => w.work_study);
            
            for (const worker of workStudyWorkers) {
                const assignmentResult = await assignWorkStudyStudentFixed(worker, hoursOfOperation, schedule, assignedHours);
                
                if (assignmentResult.success) {
                    console.log(`✅ Assigned ${worker.first_name} ${worker.last_name}: ${assignmentResult.hoursAssigned} hours`);
                } else {
                    wsIssues.push(`${worker.first_name} ${worker.last_name}: ${assignmentResult.reason}`);
                    console.warn(`⚠️ Could not fully assign ${worker.first_name} ${worker.last_name}: ${assignmentResult.reason}`);
                }
            }
            
            // PHASE 2: Fill remaining time slots with regular workers
            console.log('📋 Phase 2: Filling remaining shifts with regular workers...');
            
            const sortedDays = window.DAYS.filter(day => hoursOfOperation[day] && hoursOfOperation[day].length > 0);
            
            for (const day of sortedDays) {
                const dayHours = hoursOfOperation[day];
                if (!dayHours || dayHours.length === 0) continue;
                
                // Initialize day in schedule if needed
                if (!schedule[day]) schedule[day] = [];
                
                for (const hours of dayHours) {
                    await fillDayWithRegularWorkersFixed(
                        day, 
                        hours, 
                        schedule, 
                        workersData, 
                        assignedHours, 
                        maxHoursPerWorker, 
                        maxWorkersPerShift,
                        unfilledShifts,
                        alternativeSolutions
                    );
                }
                
                // Sort shifts by start time
                schedule[day].sort((a, b) => window.timeToHour(a.start) - window.timeToHour(b.start));
            }
            
            console.log('📋 Final assigned hours:', assignedHours);
            
            // PHASE 3: Analysis and reporting
            const analysisResult = analyzeScheduleResults(workersData, assignedHours, minHoursPerWorker);
            
            return {
                schedule,
                assignedHours,
                lowHours: analysisResult.lowHours,
                unassigned: analysisResult.unassigned,
                alternativeSolutions,
                unfilledShifts,
                wsIssues,
                minHoursIssues: analysisResult.minHoursIssues,
                totalShifts: Object.values(schedule).flat().length,
                analytics: analysisResult.analytics
            };
        }

        // FIXED: Assign work study student
        async function assignWorkStudyStudentFixed(worker, hoursOfOperation, schedule, assignedHours) {
            console.log(`🎓 Assigning work study student: ${worker.first_name} ${worker.last_name}`);
            
            // Find all available time windows for this worker
            const availableWindows = [];
            
            for (const [day, dayHours] of Object.entries(hoursOfOperation)) {
                if (!dayHours || dayHours.length === 0) continue;
                
                for (const hours of dayHours) {
                    const startHour = hours.start_hour;
                    const endHour = hours.end_hour;
                    
                    // Check if worker is available during this entire period
                    if (window.isWorkerAvailableDuringHours(worker, day, startHour, endHour)) {
                        availableWindows.push({
                            day,
                            start: startHour,
                            end: endHour,
                            duration: endHour - startHour
                        });
                    }
                }
            }
            
            console.log(`Available windows for ${worker.first_name}:`, availableWindows);
            
            // Try to find optimal 5-hour assignment
            const optimalAssignment = findOptimalWorkStudyAssignmentFixed(availableWindows, WORK_STUDY_TARGET_HOURS);
            
            if (optimalAssignment.totalHours >= 4.5) { // Allow some tolerance
                // Apply the assignment
                for (const window of optimalAssignment.windows) {
                    await createWorkStudyShiftFixed(worker, window, schedule, assignedHours);
                }
                
                console.log(`✅ Assigned ${worker.first_name}: ${optimalAssignment.totalHours} hours`);
                
                return {
                    success: true,
                    hoursAssigned: optimalAssignment.totalHours,
                    reason: `Assigned ${optimalAssignment.totalHours.toFixed(1)} hours`
                };
            } else {
                return {
                    success: false,
                    hoursAssigned: optimalAssignment.totalHours,
                    reason: `Only ${optimalAssignment.totalHours.toFixed(1)} hours available during operating hours`
                };
            }
        }

        // FIXED: Find optimal work study assignment
        function findOptimalWorkStudyAssignmentFixed(windows, targetHours) {
            // Try perfect 5-hour single window
            for (const window of windows) {
                if (Math.abs(window.duration - targetHours) < 0.1) {
                    return {
                        windows: [window],
                        totalHours: window.duration
                    };
                }
            }
            
            // Try preferred 3+2 hour combinations
            for (const split of PREFERRED_WS_SPLITS) {
                const combination = findHourCombinationFixed(windows, split.split1, split.split2);
                if (combination && Math.abs(combination.totalHours - targetHours) < 0.1) {
                    return combination;
                }
            }
            
            // Try any combination that gets close to 5 hours
            return findBestHourCombinationFixed(windows, targetHours);
        }

        // FIXED: Find specific hour combination
        function findHourCombinationFixed(windows, hours1, hours2) {
            for (let i = 0; i < windows.length; i++) {
                const window1 = windows[i];
                if (Math.abs(window1.duration - hours1) < 0.1) {
                    
                    for (let j = 0; j < windows.length; j++) {
                        if (i === j) continue;
                        const window2 = windows[j];
                        
                        if (Math.abs(window2.duration - hours2) < 0.1) {
                            // Check for day conflicts
                            if (window1.day !== window2.day) {
                                return {
                                    windows: [window1, window2],
                                    totalHours: window1.duration + window2.duration
                                };
                            }
                        }
                    }
                }
            }
            return null;
        }

        // FIXED: Find best combination of hours
        function findBestHourCombinationFixed(windows, targetHours) {
            const sortedWindows = [...windows].sort((a, b) => b.duration - a.duration);
            let bestCombination = { windows: [], totalHours: 0 };
            
            // Try single windows first
            for (const window of sortedWindows) {
                if (window.duration <= targetHours && window.duration > bestCombination.totalHours) {
                    bestCombination = {
                        windows: [window],
                        totalHours: window.duration
                    };
                }
            }
            
            // Try combinations of windows on different days
            for (let i = 0; i < sortedWindows.length; i++) {
                for (let j = i + 1; j < sortedWindows.length; j++) {
                    const window1 = sortedWindows[i];
                    const window2 = sortedWindows[j];
                    
                    // Only combine if on different days
                    if (window1.day !== window2.day) {
                        const totalHours = window1.duration + window2.duration;
                        if (totalHours <= targetHours && totalHours > bestCombination.totalHours) {
                            bestCombination = {
                                windows: [window1, window2],
                                totalHours: totalHours
                            };
                        }
                    }
                }
            }
            
            return bestCombination;
        }

        // FIXED: Create work study shift
        async function createWorkStudyShiftFixed(worker, window, schedule, assignedHours) {
            const { day, start, end, duration } = window;
            
            const shift = {
                start: window.hourToTimeStr(start),
                end: window.hourToTimeStr(end),
                assigned: [`${worker.first_name} ${worker.last_name}`],
                raw_assigned: [worker.email],
                available: [`${worker.first_name} ${worker.last_name}`],
                all_available: [worker],
                is_work_study: true
            };
            
            if (!schedule[day]) schedule[day] = [];
            schedule[day].push(shift);
            
            // CRITICAL FIX: Ensure we're updating the hours correctly
            if (!assignedHours[worker.email]) {
                assignedHours[worker.email] = 0;
            }
            assignedHours[worker.email] += duration;
            
            console.log(`📝 Added ${duration} hours for ${worker.first_name}, total now: ${assignedHours[worker.email]}`);
        }

        // FIXED: Fill day with regular workers
        async function fillDayWithRegularWorkersFixed(day, hours, schedule, workersData, assignedHours, maxHoursPerWorker, maxWorkersPerShift, unfilledShifts, alternativeSolutions) {
            const startHour = hours.start_hour;
            const endHour = hours.end_hour;
            
            console.log(`🏗️ Filling ${day} from ${startHour} to ${endHour}`);
            
            // Find free time slots (not occupied by work study students)
            const freeSlots = findFreeSlotsFixed(day, startHour, endHour, schedule[day] || []);
            
            console.log(`Found ${freeSlots.length} free slots for ${day}:`, freeSlots);
            
            for (const slot of freeSlots) {
                await fillTimeSlotWithWorkersFixed(
                    day, 
                    slot, 
                    schedule, 
                    workersData, 
                    assignedHours, 
                    maxHoursPerWorker, 
                    maxWorkersPerShift,
                    unfilledShifts,
                    alternativeSolutions
                );
            }
        }

        // FIXED: Find free time slots
        function findFreeSlotsFixed(day, startHour, endHour, existingShifts) {
            const occupiedRanges = [];
            
            // Get all occupied time ranges
            for (const shift of existingShifts) {
                const shiftStart = window.timeToHour(shift.start);
                const shiftEnd = window.timeToHour(shift.end);
                occupiedRanges.push({ start: shiftStart, end: shiftEnd });
            }
            
            // Sort occupied ranges
            occupiedRanges.sort((a, b) => a.start - b.start);
            
            // Find free slots
            const freeSlots = [];
            let currentStart = startHour;
            
            for (const range of occupiedRanges) {
                if (currentStart < range.start) {
                    freeSlots.push({
                        start: currentStart,
                        end: range.start
                    });
                }
                currentStart = Math.max(currentStart, range.end);
            }
            
            // Add final slot if there's time left
            if (currentStart < endHour) {
                freeSlots.push({
                    start: currentStart,
                    end: endHour
                });
            }
            
            // Filter out slots shorter than 2 hours
            return freeSlots.filter(slot => slot.end - slot.start >= 2);
        }

        // FIXED: Fill time slot with workers
        async function fillTimeSlotWithWorkersFixed(day, slot, schedule, workersData, assignedHours, maxHoursPerWorker, maxWorkersPerShift, unfilledShifts, alternativeSolutions) {
            let currentHour = slot.start;
            
            console.log(`⏰ Filling slot ${day} ${currentHour}-${slot.end}`);
            
            while (currentHour < slot.end) {
                // Determine shift length (2-4 hours)
                const remainingTime = slot.end - currentHour;
                const possibleLengths = SHIFT_LENGTHS.filter(length => length <= remainingTime && length >= 2);
                
                if (possibleLengths.length === 0) break;
                
                const shiftLength = possibleLengths[Math.floor(Math.random() * possibleLengths.length)];
                const shiftEnd = currentHour + shiftLength;
                
                // Find available workers for this shift
                const availableWorkers = findAvailableWorkersForShiftFixed(
                    workersData, 
                    day, 
                    currentHour, 
                    shiftEnd, 
                    assignedHours, 
                    maxHoursPerWorker
                );
                
                console.log(`Found ${availableWorkers.length} available workers for ${day} ${currentHour}-${shiftEnd}`);
                
                // Sort by hours assigned (fairness)
                availableWorkers.sort((a, b) => {
                    const hoursA = assignedHours[a.email] || 0;
                    const hoursB = assignedHours[b.email] || 0;
                    return hoursA - hoursB;
                });
                
                // Select workers for this shift
                const selectedWorkers = availableWorkers.slice(0, maxWorkersPerShift);
                
                // Create the shift
                const shift = {
                    start: window.hourToTimeStr(currentHour),
                    end: window.hourToTimeStr(shiftEnd),
                    assigned: selectedWorkers.length > 0 ? 
                        selectedWorkers.map(w => `${w.first_name} ${w.last_name}`) : 
                        ['Unfilled'],
                    raw_assigned: selectedWorkers.map(w => w.email),
                    available: availableWorkers.map(w => `${w.first_name} ${w.last_name}`),
                    all_available: availableWorkers
                };
                
                // Add to schedule
                if (!schedule[day]) schedule[day] = [];
                schedule[day].push(shift);
                
                // CRITICAL FIX: Update assigned hours correctly
                selectedWorkers.forEach(worker => {
                    if (!assignedHours[worker.email]) {
                        assignedHours[worker.email] = 0;
                    }
                    assignedHours[worker.email] += shiftLength;
                    console.log(`📈 Added ${shiftLength} hours for ${worker.first_name}, total: ${assignedHours[worker.email]}`);
                });
                
                // Track unfilled shifts
                if (selectedWorkers.length === 0) {
                    unfilledShifts.push({
                        day,
                        start: shift.start,
                        end: shift.end
                    });
                }
                
                currentHour = shiftEnd;
            }
        }

        // FIXED: Find available workers for shift
        function findAvailableWorkersForShiftFixed(workersData, day, startHour, endHour, assignedHours, maxHoursPerWorker) {
            return workersData.filter(worker => {
                // Skip work study students who already have their hours assigned
                if (worker.work_study && (assignedHours[worker.email] || 0) >= WORK_STUDY_TARGET_HOURS - 0.1) {
                    return false;
                }
                
                // Check availability
                if (!window.isWorkerAvailableDuringHours(worker, day, startHour, endHour)) {
                    return false;
                }
                
                // Check hours limit
                const currentHours = assignedHours[worker.email] || 0;
                const shiftDuration = endHour - startHour;
                
                return currentHours + shiftDuration <= maxHoursPerWorker;
            });
        }

        // Calculate assigned hours per worker
        window.calculateAssignedHours = function(schedule) {
            const assignedHours = {};
            
            for (const [day, shifts] of Object.entries(schedule)) {
                for (const shift of shifts) {
                    const startHour = window.timeToHour(shift.start);
                    const endHour = window.timeToHour(shift.end);
                    const duration = endHour - startHour;
                    
                    const workers = shift.raw_assigned || [];
                    workers.forEach(email => {
                        assignedHours[email] = (assignedHours[email] || 0) + duration;
                    });
                }
            }
            
            return assignedHours;
        };

        // Analyze schedule results
        function analyzeScheduleResults(workersData, assignedHours, minHoursPerWorker) {
            const lowHours = [];
            const unassigned = [];
            const minHoursIssues = [];
            
            workersData.forEach(worker => {
                const hours = assignedHours[worker.email] || 0;
                const workerName = `${worker.first_name} ${worker.last_name}`;
                
                if (worker.work_study) {
                    return; // Work study analysis handled separately
                }
                
                if (hours === 0) {
                    unassigned.push(workerName);
                } else if (hours < 4) {
                    lowHours.push(workerName);
                }
                
                if (hours < minHoursPerWorker) {
                    minHoursIssues.push(workerName);
                }
            });
            
            const analytics = generateScheduleAnalytics(workersData, assignedHours);
            
            return {
                lowHours,
                unassigned,
                minHoursIssues,
                analytics
            };
        }

        // Generate schedule analytics
        function generateScheduleAnalytics(workersData, assignedHours) {
            const totalWorkers = workersData.length;
            const workStudyWorkers = workersData.filter(w => w.work_study).length;
            const regularWorkers = totalWorkers - workStudyWorkers;
            
            const assignedWorkers = Object.keys(assignedHours).filter(email => assignedHours[email] > 0).length;
            const totalHoursAssigned = Object.values(assignedHours).reduce((sum, hours) => sum + hours, 0);
            const averageHoursPerWorker = assignedWorkers > 0 ? totalHoursAssigned / assignedWorkers : 0;
            
            const workStudyFullyAssigned = workersData.filter(w => 
                w.work_study && Math.abs((assignedHours[w.email] || 0) - WORK_STUDY_TARGET_HOURS) < 0.1
            ).length;
            
            return {
                totalWorkers,
                workStudyWorkers,
                regularWorkers,
                assignedWorkers,
                unassignedWorkers: totalWorkers - assignedWorkers,
                totalHoursAssigned: totalHoursAssigned.toFixed(1),
                averageHoursPerWorker: averageHoursPerWorker.toFixed(1),
                workStudyFullyAssigned,
                workStudyIssues: workStudyWorkers - workStudyFullyAssigned
            };
        }

        // Save schedule to Firebase
        async function saveScheduleToFirebase(schedule, setAsCurrent = false) {
            try {
                await window.initializeWorkplace(window.selectedWorkplace);
                
                const scheduleData = {
                    days: schedule,
                    created_at: new Date().toISOString(),
                    workplace_id: window.selectedWorkplace,
                    name: `${window.selectedWorkplace.replace('_', ' ').toUpperCase()} Schedule ${new Date().toLocaleDateString()}`
                };
                
                const schedulesRef = collection(window.workplaceDb, 'workplaces', window.selectedWorkplace, 'schedules');
                const docRef = await addDoc(schedulesRef, scheduleData);
                console.log(`Schedule saved with ID: ${docRef.id}`);
                
                if (setAsCurrent) {
                    const workplaceRef = doc(window.workplaceDb, 'workplaces', window.selectedWorkplace);
                    await updateDoc(workplaceRef, {
                        current_schedule_id: docRef.id,
                        updated_at: new Date().toISOString()
                    });
                    window.currentSchedule = schedule;
                }
                
                return docRef.id;
            } catch (error) {
                console.error('❌ Error saving schedule to Firebase:', error);
                throw error;
            }
        }

        // Load current schedule
        window.loadCurrentSchedule = async function() {
            try {
                await window.initializeWorkplace(window.selectedWorkplace);
                
                const workplaceRef = doc(window.workplaceDb, 'workplaces', window.selectedWorkplace);
                const workplaceDoc = await getDoc(workplaceRef);
                
                if (workplaceDoc.exists()) {
                    const data = workplaceDoc.data();
                    const currentScheduleId = data.current_schedule_id;
                    
                    if (currentScheduleId) {
                        const scheduleRef = doc(window.workplaceDb, 'workplaces', window.selectedWorkplace, 'schedules', currentScheduleId);
                        const scheduleDoc = await getDoc(scheduleRef);
                        
                        if (scheduleDoc.exists()) {
                            const data = scheduleDoc.data();
                            if (data.days) {
                                window.currentSchedule = data.days;
                                return data.days;
                            } else {
                                window.currentSchedule = data;
                                return data;
                            }
                        }
                    }
                }
                
                // Look for most recent schedule
                const schedulesRef = collection(window.workplaceDb, 'workplaces', window.selectedWorkplace, 'schedules');
                const querySnapshot = await getDocs(query(schedulesRef, orderBy('created_at', 'desc'), limit(1)));
                
                if (!querySnapshot.empty) {
                    const scheduleDoc = querySnapshot.docs[0];
                    const data = scheduleDoc.data();
                    
                    if (data.days) {
                        window.currentSchedule = data.days;
                        return data.days;
                    } else {
                        window.currentSchedule = data;
                        return data;
                    }
                }
                
                window.currentSchedule = null;
                return null;
            } catch (error) {
                console.error('❌ Error loading current schedule:', error);
                throw error;
            }
        };

        // View current schedule
        window.viewCurrentSchedule = async function() {
            if (!window.selectedWorkplace) {
                alert('Please select a workplace first.');
                return;
            }
            
            document.getElementById('scheduleContent').innerHTML = `
                <div class="loading">Loading current schedule...</div>
            `;
            document.getElementById('generateScheduleForm').style.display = 'none';
            document.getElementById('shiftOverrideSection').style.display = 'none';
            document.getElementById('scheduleHistorySection').style.display = 'none';
            
            try {
                const schedule = await window.loadCurrentSchedule();
                
                if (schedule) {
                    displayScheduleWithPublishOption(schedule, true);
                } else {
                    document.getElementById('scheduleContent').innerHTML = `
                        <p>No current schedule found. Please generate a new schedule first.</p>
                    `;
                }
            } catch (error) {
                console.error('❌ Error viewing current schedule:', error);
                document.getElementById('scheduleContent').innerHTML = `
                    <h4>❌ Error Loading Schedule</h4>
                    <p>Error: ${error.message}</p>
                `;
            }
        };

        console.log('📅 Advanced schedule management module loaded');
    </script>

<script type="module">
        // Complete Export Functionality and Application Initialization
        
        // Enhanced schedule display with analytics
        function displayAdvancedScheduleWithAnalytics(scheduleResult, isCurrent = false, scheduleId = null) {
            const { schedule, assignedHours, analytics, wsIssues, unfilledShifts } = scheduleResult;
            
            const totalShifts = Object.values(schedule).flat().length;
            const unfilledCount = unfilledShifts.length;
            const assignedWorkers = Object.keys(assignedHours).filter(email => assignedHours[email] > 0).length;
            
            let html = '';
            
            if (isCurrent) {
                html += `
                    <div class="publish-banner">
                        <strong>✅ This is the current active schedule</strong>
                    </div>
                `;
            } else if (scheduleId) {
                html += `
                    <button class="publish-btn" onclick="publishSchedule('${scheduleId}')">
                        📢 Publish as Current Schedule
                    </button>
                    <p style="margin-bottom: 1rem; font-style: italic;">This is a draft schedule. Click the button above to publish it as the current active schedule.</p>
                `;
            }
            
            html += `
                <div class="stats" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-number">${totalShifts}</div>
                        <div class="stat-label">Total Shifts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${unfilledCount}</div>
                        <div class="stat-label">Unfilled Shifts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${assignedWorkers}</div>
                        <div class="stat-label">Workers Assigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${analytics.totalHoursAssigned}</div>
                        <div class="stat-label">Total Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${analytics.averageHoursPerWorker}</div>
                        <div class="stat-label">Avg Hours/Worker</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${analytics.workStudyFullyAssigned}/${analytics.workStudyWorkers}</div>
                        <div class="stat-label">Work Study OK</div>
                    </div>
                </div>
            `;
            
            // Show warnings
            if (wsIssues.length > 0 || unfilledShifts.length > 0) {
                html += generateWarningSection(wsIssues, unfilledShifts, scheduleResult.alternativeSolutions);
            }
            
            // Display schedule by day
            html += generateScheduleDisplayByDay(schedule);
            
            // Worker hours summary
            html += generateEnhancedWorkerSummary(assignedHours, analytics);
            
            // Export options
            html += generateExportOptions();
            
            document.getElementById('scheduleContent').innerHTML = html;
        }

        function generateWarningSection(wsIssues, unfilledShifts, alternativeSolutions) {
            let html = '';
            
            if (wsIssues.length > 0) {
                html += `
                    <div class="schedule-warning">
                        <h5>⚠️ Work Study Issues</h5>
                        <p>The following work study students could not be assigned exactly 5 hours:</p>
                        <ul>
                            ${wsIssues.map(issue => `<li class="work-study-issue">${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (unfilledShifts.length > 0) {
                html += `
                    <div class="schedule-warning">
                        <h5>⚠️ Unfilled Shifts (${unfilledShifts.length})</h5>
                        <p>The following shifts could not be filled:</p>
                        <ul>
                `;
                
                unfilledShifts.forEach(shift => {
                    const shiftKey = `${shift.day} ${shift.start}-${shift.end}`;
                    const alternatives = alternativeSolutions[shiftKey] || [];
                    
                    html += `<li>
                        ${shift.day} ${window.formatTimeAMPM(shift.start)}-${window.formatTimeAMPM(shift.end)}
                        ${alternatives.length > 0 ? `<br><small style="color: #6c757d;">Alternatives: ${alternatives.join(', ')}</small>` : ''}
                    </li>`;
                });
                
                html += `</ul></div>`;
            }
            
            return html;
        }

        function generateScheduleDisplayByDay(schedule) {
            let html = '<h5 style="margin-top: 2rem;">Schedule by Day</h5>';
            
            for (const day of window.DAYS) {
                const shifts = schedule[day] || [];
                if (shifts.length === 0) continue;
                
                html += `<div class="schedule-day-header">${day}</div>`;
                
                shifts.forEach(shift => {
                    const isUnfilled = shift.assigned && shift.assigned.includes('Unfilled');
                    const isWorkStudy = shift.is_work_study || false;
                    
                    html += `
                        <div class="schedule-shift ${isUnfilled ? 'unfilled' : ''} ${isWorkStudy ? 'work-study' : ''}">
                            <div class="schedule-time">
                                ${window.formatTimeAMPM(shift.start)} - ${window.formatTimeAMPM(shift.end)}
                                ${isWorkStudy ? '<small style="color: #28a745;">(Work Study)</small>' : ''}
                            </div>
                            <div class="schedule-workers">
                                ${isUnfilled ? '<span class="unfilled-text">Unfilled</span>' : shift.assigned.join(', ')}
                            </div>
                        </div>
                    `;
                });
            }
            
            return html;
        }

        function generateEnhancedWorkerSummary(assignedHours, analytics) {
            let html = `
                <h5 style="margin-top: 2rem;">Worker Hours Analysis</h5>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Worker</th>
                            <th>Hours</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const sortedWorkers = Object.entries(assignedHours).sort((a, b) => b[1] - a[1]);
            
            sortedWorkers.forEach(([email, hours]) => {
                const worker = window.workers.find(w => w.email === email);
                if (!worker) return;
                
                const name = `${worker.first_name} ${worker.last_name}`;
                const isWorkStudy = worker.work_study === true || worker.work_study === 'Yes';
                
                let status = '';
                let statusClass = '';
                
                if (isWorkStudy) {
                    if (Math.abs(hours - 5) < 0.1) {
                        status = 'Perfect (5 hrs)';
                    } else {
                        status = `WS Issue (${hours.toFixed(1)} hrs)`;
                        statusClass = 'unfilled-text';
                    }
                } else {
                    if (hours === 0) {
                        status = 'Unassigned';
                        statusClass = 'unfilled-text';
                    } else if (hours < 3) {
                        status = 'Low Hours';
                        statusClass = 'unfilled-text';
                    } else {
                        status = 'OK';
                    }
                }
                
                html += `
                    <tr>
                        <td>${name} ${isWorkStudy ? '<small>(Work Study)</small>' : ''}</td>
                        <td>${hours.toFixed(1)}</td>
                        <td class="${statusClass}">${status}</td>
                    </tr>
                `;
            });
            
            // Add unassigned workers
            const assignedEmails = Object.keys(assignedHours);
            const unassignedWorkers = window.workers.filter(w => !assignedEmails.includes(w.email));
            
            unassignedWorkers.forEach(worker => {
                const name = `${worker.first_name} ${worker.last_name}`;
                const isWorkStudy = worker.work_study === true || worker.work_study === 'Yes';
                
                html += `
                    <tr>
                        <td>${name} ${isWorkStudy ? '<small>(Work Study)</small>' : ''}</td>
                        <td>0.0</td>
                        <td class="unfilled-text">Unassigned</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            return html;
        }

        function generateExportOptions() {
            return `
                <div style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
                    <h5>📤 Export & Share Options</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <button onclick="printSchedule()" class="history-btn" style="background: #6c757d;">
                            🖨️ Print Schedule
                        </button>
                        <button onclick="exportScheduleToExcel()" class="history-btn" style="background: #28a745;">
                            📊 Export to Excel
                        </button>
                        <button onclick="emailSchedule()" class="history-btn" style="background: #007bff;">
                            📧 Email Schedule
                        </button>
                        <button onclick="copyScheduleToClipboard()" class="history-btn" style="background: #17a2b8;">
                            📋 Copy to Clipboard
                        </button>
                    </div>
                </div>
            `;
        }

        // COMPLETE EXPORT IMPLEMENTATIONS

        // Print schedule
        window.printSchedule = function() {
            const scheduleToPrint = window.draftSchedule || window.currentSchedule;
            
            if (!scheduleToPrint) {
                alert('No schedule to print.');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            
            let printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${window.selectedWorkplace.replace('_', ' ')} Schedule</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { text-align: center; color: #007bff; }
                        .day-header { font-size: 18px; font-weight: bold; margin-top: 20px; padding-bottom: 5px; border-bottom: 1px solid #ddd; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th { background-color: #f8f9fa; padding: 8px; text-align: left; border-bottom: 2px solid #ddd; }
                        td { padding: 8px; border-bottom: 1px solid #ddd; }
                        .unfilled { color: #dc3545; font-weight: bold; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>${window.selectedWorkplace.replace('_', ' ').toUpperCase()} Schedule</h1>
                    <p style="text-align: center;">Generated: ${new Date().toLocaleDateString()}</p>
            `;
            
            for (const day of window.DAYS) {
                const shifts = scheduleToPrint[day] || [];
                if (shifts.length === 0) continue;
                
                printContent += `<div class="day-header">${day}</div>`;
                printContent += `<table><thead><tr><th>Time</th><th>Assigned Workers</th></tr></thead><tbody>`;
                
                shifts.forEach(shift => {
                    const isUnfilled = shift.assigned && shift.assigned.includes('Unfilled');
                    printContent += `
                        <tr>
                            <td>${window.formatTimeAMPM(shift.start)} - ${window.formatTimeAMPM(shift.end)}</td>
                            <td class="${isUnfilled ? 'unfilled' : ''}">
                                ${shift.assigned ? shift.assigned.join(', ') : 'Unassigned'}
                            </td>
                        </tr>
                    `;
                });
                
                printContent += `</tbody></table>`;
            }
            
            printContent += `</body></html>`;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        };

        // Export to Excel (CSV format)
        window.exportScheduleToExcel = function() {
            const scheduleToCopy = window.draftSchedule || window.currentSchedule;
            if (!scheduleToCopy) {
                alert('No schedule to export.');
                return;
            }
            
            let csvContent = 'Day,Time,Workers\n';
            
            for (const day of window.DAYS) {
                const shifts = scheduleToCopy[day] || [];
                if (shifts.length === 0) {
                    csvContent += `${day},No shifts,\n`;
                    continue;
                }
                
                shifts.forEach(shift => {
                    const timeRange = `${window.formatTimeAMPM(shift.start)} - ${window.formatTimeAMPM(shift.end)}`;
                    const workers = shift.assigned ? shift.assigned.join('; ') : 'Unfilled';
                    csvContent += `${day},"${timeRange}","${workers}"\n`;
                });
            }
            
            // Add worker hours summary
            const assignedHours = window.calculateAssignedHours(scheduleToCopy);
            csvContent += '\n\nWorker,Hours,Status\n';
            
            const sortedWorkers = Object.entries(assignedHours).sort((a, b) => b[1] - a[1]);
            sortedWorkers.forEach(([email, hours]) => {
                const worker = window.workers.find(w => w.email === email);
                if (worker) {
                    const name = `${worker.first_name} ${worker.last_name}`;
                    const isWorkStudy = worker.work_study ? 'Work Study' : 'Regular';
                    csvContent += `"${name}",${hours.toFixed(1)},${isWorkStudy}\n`;
                }
            });
            
            // Create download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${window.selectedWorkplace}_schedule_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Email schedule
        window.emailSchedule = function() {
            const scheduleToCopy = window.draftSchedule || window.currentSchedule;
            if (!scheduleToCopy) {
                alert('No schedule to email.');
                return;
            }
            
            let emailBody = `${window.selectedWorkplace.replace('_', ' ').toUpperCase()} SCHEDULE\n`;
            emailBody += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            
            for (const day of window.DAYS) {
                const shifts = scheduleToCopy[day] || [];
                if (shifts.length === 0) continue;
                
                emailBody += `${day.toUpperCase()}\n`;
                emailBody += '='.repeat(day.length) + '\n';
                
                shifts.forEach(shift => {
                    const isUnfilled = shift.assigned && shift.assigned.includes('Unfilled');
                    emailBody += `${window.formatTimeAMPM(shift.start)} - ${window.formatTimeAMPM(shift.end)}: `;
                    emailBody += isUnfilled ? 'UNFILLED' : shift.assigned.join(', ');
                    emailBody += '\n';
                });
                emailBody += '\n';
            }
            
            // Add worker hours summary
            const assignedHours = window.calculateAssignedHours(scheduleToCopy);
            emailBody += 'WORKER HOURS SUMMARY\n';
            emailBody += '===================\n';
            
            const sortedWorkers = Object.entries(assignedHours).sort((a, b) => b[1] - a[1]);
            sortedWorkers.forEach(([email, hours]) => {
                const worker = window.workers.find(w => w.email === email);
                if (worker) {
                    const name = `${worker.first_name} ${worker.last_name}`;
                    emailBody += `${name}: ${hours.toFixed(1)} hours\n`;
                }
            });
            
            const subject = `Schedule for ${window.selectedWorkplace.replace('_', ' ')} - ${new Date().toLocaleDateString()}`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            window.location.href = mailtoLink;
        };

        // Copy to clipboard
        window.copyScheduleToClipboard = async function() {
            const scheduleToCopy = window.draftSchedule || window.currentSchedule;
            if (!scheduleToCopy) {
                alert('No schedule to copy.');
                return;
            }
            
            let text = `${window.selectedWorkplace.replace('_', ' ').toUpperCase()} SCHEDULE\n`;
            text += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            
            for (const day of window.DAYS) {
                const shifts = scheduleToCopy[day] || [];
                if (shifts.length === 0) continue;
                
                text += `${day.toUpperCase()}\n`;
                text += '='.repeat(day.length) + '\n';
                
                shifts.forEach(shift => {
                    const isUnfilled = shift.assigned && shift.assigned.includes('Unfilled');
                    text += `${window.formatTimeAMPM(shift.start)} - ${window.formatTimeAMPM(shift.end)}: `;
                    text += isUnfilled ? 'UNFILLED' : shift.assigned.join(', ');
                    text += '\n';
                });
                text += '\n';
            }
            
            try {
                await navigator.clipboard.writeText(text);
                alert('✅ Schedule copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy to clipboard:', err);
                alert('❌ Failed to copy to clipboard. Please try again.');
            }
        };

        // Display schedule with publish option
        function displayScheduleWithPublishOption(schedule, isCurrent = false, scheduleId = null) {
            if (!schedule) return;
            
            const assignedHours = window.calculateAssignedHours(schedule);
            const totalShifts = Object.values(schedule).flat().length;
            const unfilledShifts = Object.values(schedule).flat().filter(shift => 
                shift.assigned && shift.assigned.includes('Unfilled')).length;
            const assignedWorkers = Object.keys(assignedHours).length;
            
            let html = '';
            
            if (isCurrent) {
                html += `
                    <div class="publish-banner">
                        <strong>✅ This is the current active schedule</strong>
                    </div>
                `;
            } else if (scheduleId) {
                html += `
                    <button class="publish-btn" onclick="publishSchedule('${scheduleId}')">
                        📢 Publish as Current Schedule
                    </button>
                    <p style="margin-bottom: 1rem; font-style: italic;">This is a draft schedule.</p>
                `;
            }
            
            html += `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalShifts}</div>
                        <div class="stat-label">Total Shifts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${unfilledShifts}</div>
                        <div class="stat-label">Unfilled Shifts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${assignedWorkers}</div>
                        <div class="stat-label">Workers Assigned</div>
                    </div>
                </div>
            `;
            
            // Display schedule
            html += generateScheduleDisplayByDay(schedule);
            
            // Worker summary
            html += `
                <h5 style="margin-top: 2rem;">Worker Hours Summary</h5>
                <table class="user-table">
                    <thead>
                        <tr><th>Worker</th><th>Hours</th><th>Status</th></tr>
                    </thead>
                    <tbody>
            `;
            
            const sortedWorkers = Object.entries(assignedHours).sort((a, b) => b[1] - a[1]);
            sortedWorkers.forEach(([email, hours]) => {
                const worker = window.workers.find(w => w.email === email);
                if (!worker) return;
                
                const name = `${worker.first_name} ${worker.last_name}`;
                const isWorkStudy = worker.work_study;
                let status = hours < 3 ? 'Low Hours' : 'OK';
                
                if (isWorkStudy && hours !== 5) {
                    status = 'Work Study Hours Issue';
                }
                
                html += `
                    <tr>
                        <td>${name} ${isWorkStudy ? '<small>(Work Study)</small>' : ''}</td>
                        <td>${hours.toFixed(1)}</td>
                        <td>${status}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            html += generateExportOptions();
            
            document.getElementById('scheduleContent').innerHTML = html;
        }

        // Publish schedule
        window.publishSchedule = async function(scheduleId) {
            if (confirm('Are you sure you want to publish this schedule as the current active schedule?')) {
                try {
                    const workplaceRef = doc(window.workplaceDb, 'workplaces', window.selectedWorkplace);
                    await updateDoc(workplaceRef, {
                        current_schedule_id: scheduleId,
                        updated_at: new Date().toISOString()
                    });
                    
                    const scheduleRef = doc(window.workplaceDb, 'workplaces', window.selectedWorkplace, 'schedules', scheduleId);
                    const scheduleDoc = await getDoc(scheduleRef);
                    
                    if (scheduleDoc.exists()) {
                        const data = scheduleDoc.data();
                        window.currentSchedule = data.days;
                        window.draftSchedule = null;
                    }
                    
                    alert('✅ Schedule published successfully!');
                    viewScheduleHistory();
                } catch (error) {
                    console.error('❌ Error publishing schedule:', error);
                    alert('❌ Error publishing schedule: ' + error.message);
                }
            }
        };

        // Additional placeholder functions for complete functionality
        window.viewScheduleHistory = function() {
            alert('Schedule history feature coming soon!');
        };

        window.openShiftOverride = function() {
            alert('Shift override feature coming soon!');
        };

        window.hideShiftOverride = function() {
            document.getElementById('shiftOverrideSection').style.display = 'none';
        };

        window.saveShiftOverrides = function() {
            alert('Save overrides feature coming soon!');
        };

        window.hideScheduleHistory = function() {
            document.getElementById('scheduleHistorySection').style.display = 'none';
        };

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Workplace Manager Dashboard...');
            window.initApp();
        });

        console.log('📤 Export functionality and initialization module loaded');
    </script>

    <!-- Initialize the app -->
    <script>
        // Final initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 All modules loaded, starting application...');
        });
    </script>
</body>
</html>
